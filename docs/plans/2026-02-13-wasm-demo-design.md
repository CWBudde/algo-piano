# WebAssembly Piano Demo Design

**Date:** 2026-02-13
**Status:** Approved
**Target URL:** https://cwbudde.github.io/algo-piano/

## Overview

This design describes a browser-based piano demo using Go WebAssembly with AudioWorklet for real-time synthesis. All audio processing happens in WASM; Web Audio provides only routing to the output.

## Requirements

- **Minimal UI:** 1-2 octave piano keyboard with click-to-play interaction
- **Optional keyboard mapping:** Computer keyboard for note input
- **Sustain pedal:** Toggle button for sustain control
- **IR handling:** Fetch IR at runtime; gracefully degrade if unavailable
- **Build:** Standard Go WASM (not TinyGo)
- **Deployment:** GitHub Actions to GitHub Pages at cwbudde.github.io/algo-piano

## Architecture

### Component Diagram

```
┌─────────────────────────────────────────────┐
│ HTML/CSS Piano Keyboard UI (1-2 octaves)   │
│ - Mouse/touch click handlers               │
│ - Computer keyboard mapping (ASDF keys)    │
│ - Sustain pedal toggle                     │
└──────────────┬──────────────────────────────┘
               │ User events
               ▼
┌─────────────────────────────────────────────┐
│ Main Thread JavaScript (main.js)           │
│ - Load WASM + wasm_exec.js                 │
│ - Fetch IR asset via HTTP                  │
│ - Create AudioContext + PianoWorkletNode   │
│ - Route UI events → worklet via postMessage│
└──────────────┬──────────────────────────────┘
               │ MessagePort
               ▼
┌─────────────────────────────────────────────┐
│ AudioWorklet (piano-worklet.js)             │
│ - Receives MIDI-like events from main      │
│ - Calls WASM processBlock() each callback  │
│ - Copies WASM buffer → output              │
└──────────────┬──────────────────────────────┘
               │ Direct function calls
               ▼
┌─────────────────────────────────────────────┐
│ Go WASM (cmd/piano-wasm/main.go)           │
│ - Exports: init(), noteOn(), noteOff(),   │
│   setSustain(), loadIR(), processBlock()  │
│ - Uses existing piano.Piano engine         │
│ - Renders 128-frame blocks in float32     │
└─────────────────────────────────────────────┘
```

### Design Decisions

- **Block size:** 128 frames (Web Audio default, ~2.7ms at 48kHz)
- **Sample rate:** Browser's native rate (usually 48kHz, sometimes 44.1kHz)
- **Polyphony:** 16 voices max (configurable, can be increased if performance allows)
- **IR handling:** Fetch `assets/ir/default_96k.wav`, gracefully skip convolution if fetch fails
- **WASM build:** Standard Go WASM with wasm_exec.js from GOROOT

## WASM Module Interface

The Go WASM module exports these functions to JavaScript:

```go
// Initialization - called once from main thread
wasmInit(sampleRate int) → void
  - Creates Piano instance
  - Pre-allocates output buffer

// Event handlers - called from worklet thread
wasmNoteOn(note int, velocity int) → void
wasmNoteOff(note int) → void
wasmSetSustain(down bool) → void

// IR loading - called from main thread after fetch
wasmLoadIR(irDataPtr int, irDataLen int) → void
  - Decodes WAV from JS ArrayBuffer
  - Sets IR in convolver

// Audio processing - called from worklet audio callback
wasmProcessBlock(numFrames int) → int
  - Returns pointer to stereo float32 buffer
  - Buffer lives in WASM linear memory
  - JS creates Float32Array view to copy data
```

### Memory Management

- Pre-allocate persistent output buffer: `make([]float32, 128*2)`
- Return pointer to this buffer on each `processBlock()` call
- JavaScript creates Float32Array view into WASM memory
- Zero per-frame allocations in audio path

## Web Frontend Structure

### Directory Layout

```
web/
├── index.html          # Main page with piano keyboard
├── styles.css          # Keyboard styling
├── main.js            # Main thread: WASM loading, AudioContext setup
├── piano-worklet.js   # AudioWorkletProcessor implementation
├── wasm_exec.js       # Copied from GOROOT/misc/wasm/
└── dist/              # Build output (generated by CI)
    ├── piano.wasm     # Built WASM binary
    └── assets/
        └── ir/
            └── default_96k.wav
```

### UI Components

1. **Piano keyboard:** 1-2 octaves of white/black keys (HTML/CSS clickable divs)
2. **Sustain pedal:** Toggle button with on/off visual state
3. **Status display:** Loading indicator, sample rate info, IR status
4. **Optional controls:** Octave shift buttons, velocity slider

### Keyboard Mapping

- **ASDF row:** White keys (C, D, E, F, G, A, B)
- **QWERTY row:** Black keys (C#, D#, F#, G#, A#)
- **Spacebar:** Sustain pedal toggle

## GitHub Actions CI/CD

### Workflow: `.github/workflows/deploy-demo.yml`

**Trigger:** Push to `main` branch

**Jobs:**

1. **Build WASM:**

   ```bash
   GOOS=js GOARCH=wasm go build -o web/dist/piano.wasm ./cmd/piano-wasm
   cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" web/
   cp -r assets/ir web/dist/assets/
   ```

2. **Deploy to GitHub Pages:**
   - Upload `web/` directory as artifact
   - Deploy using `actions/deploy-pages@v2`

**Output:** https://cwbudde.github.io/algo-piano/

## Error Handling

### WASM Loading

- Display loading progress
- Show error with browser compatibility info if load fails
- Minimum browsers: Chrome 66+, Firefox 61+, Safari 14.1+, Edge 79+

### IR Asset Loading

- Attempt fetch `assets/ir/default_96k.wav`
- On failure (404, CORS, network):
  - Log warning to console
  - Continue without convolution (waveguide-only output)
  - Show UI notice: "Running without soundboard modeling"

### Audio Context

- AudioContext requires user interaction
- Initialize on first key click
- Show "Click any key to start" message

### Performance

- Monitor for audio glitches
- No automatic fallback (keep v1 simple)
- Suggest reducing polyphony if glitches persist

## Testing Strategy

### Local Development

1. Build WASM: `GOOS=js GOARCH=wasm go build -o web/dist/piano.wasm ./cmd/piano-wasm`
2. Serve locally: `python3 -m http.server -d web 8080`
3. Open: `http://localhost:8080`

### Production Testing

1. Push to main branch
2. Wait for GitHub Actions deployment
3. Test at https://cwbudde.github.io/algo-piano/

### Browser Testing

- Chrome/Edge (latest)
- Firefox (latest)
- Safari (macOS/iOS)

## Future Enhancements

- WebMIDI input support
- Velocity sensitivity (click position or slider)
- Visual feedback (key press animation, waveform display)
- Preset selector (different piano models)
- Recording/export to WAV
- Touch gesture support (swipe for octave shift)

## Implementation Phases

See implementation plan for detailed breakdown.
